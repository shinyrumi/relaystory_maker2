<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¦´ë ˆì´ ì´ì•¼ê¸° ê³µì‘ì†Œ ğŸ“ (Sheets ì €ì¥)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@300;400;700&family=Nanum+Pen+Script&family=Stylish&family=Sunflower:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sunflower', sans-serif;
            background-image: url("https://www.transparenttextures.com/patterns/stitched-wool.png");
        }
        .font-gaegu { font-family: 'Gaegu', cursive; }
        .font-nanum-pen { font-family: 'Nanum Pen Script', cursive; }
        .font-stylish { font-family: 'Stylish', sans-serif; }

        .container-wrapper {
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 5px groove #fecaca; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.3), 0 0 0 15px rgba(255,255,255,0.7), 0 0 0 18px #fecaca;
        }

        .title-text {
            font-family: 'Stylish', sans-serif;
            font-size: 3.2rem; 
            letter-spacing: 2px;
            text-shadow: 3px 3px 0px #fef3c7, 5px 5px 0px #fde68a, 2px 2px 8px rgba(0,0,0,0.2); 
        }
        .choice-button {
            font-family: 'Gaegu', cursive;
            font-size: 1.2rem; 
            border: 3px outset; 
            transition: all 0.2s ease-out;
            box-shadow: 0 5px 10px -2px rgba(0,0,0,0.15), 0 3px 7px -2px rgba(0,0,0,0.1);
        }
        .choice-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 25px -5px rgba(0,0,0,0.2), 0 8px 10px -6px rgba(0,0,0,0.15);
        }
        .story-stage-card {
            background-color: #feefc7; 
            border: 3px dashed #fcd34d; 
            box-shadow: 7px 7px 0px #fca120; 
        }
        .story-stage-name { font-family: 'Nanum Pen Script', cursive; font-size: 3rem; color: #d97706; }
        .story-stage-prompt { font-family: 'Sunflower', sans-serif; font-size: 1.2rem; color: #b45309; }

        .story-output-card {
            background-color: #e0f2fe; 
            border: 3px dotted #7dd3fc; 
            box-shadow: 0 0 25px rgba(56, 189, 248, 0.3);
            background-image: url("https://www.transparenttextures.com/patterns/worn-dots.png");
        }
        .story-output-card h3 { font-family: 'Stylish', sans-serif; color: #0369a1; } 
        .story-output-text { font-family: 'Nanum Pen Script', cursive; font-size: 1.7rem; line-height: 2.6rem; color: #075985; } 
        .story-segment { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px dashed #bae6fd; } 
        .story-segment:last-child { border-bottom: none; }
        .segment-author { font-family: 'Gaegu', cursive; font-size: 1rem; color: #0c4a6e; display: block; margin-bottom: 0.3rem; font-weight: bold;} 
        
        .completed-story-card {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0); 
            border: 4px solid #86efac; 
        }
        .completed-story-card h2 { font-family: 'Stylish', sans-serif; color: #15803d; } 
        .completed-story-text { font-family: 'Nanum Pen Script', cursive; font-size: 1.8rem; line-height: 2.7rem; color: #14532d; } 
        
        .text-input-area { 
            border: 3px dashed #fda4af; background-color: #fff1f2; padding: 1rem; border-radius: 0.5rem; margin-top: 1.5rem; margin-bottom: 1.5rem;
        }
        .text-input-area textarea, .text-input-area input {
            font-family: 'Gaegu', cursive; border-color: #f43f5e; width: 100%; padding: 0.5rem; border-width: 2px; border-radius: 0.375rem;
        }
        .text-input-area button { font-family: 'Stylish', sans-serif; }
        .text-input-area label { display: block; font-size: 0.875rem; font-weight: 500; color: #be123c; margin-bottom: 0.25rem; }

        #message-box { /* ì´ì „ ìŠ¤íƒ€ì¼ ìœ ì§€ */ }
        .control-button { 
            font-family: 'Stylish', sans-serif; font-size: 1.2rem; border: 3px outset;
            padding: 0.7rem 1.8rem; margin: 0.5rem; border-radius: 9999px; 
            transition: all 0.2s ease-in-out;
        }
        .control-button:hover { transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        .decision-button { font-family: 'Stylish', sans-serif !important; font-size: 1.2rem !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div class="container-wrapper p-6 sm:p-10 rounded-3xl w-full max-w-4xl">
        <header class="mb-10 text-center">
            <img src="https://placehold.co/130x130/fde68a/f59e0b?text=ì´ì•¼ê¸°&font=Gaegu" alt="ì´ì•¼ê¸° ì•„ì´ì½˜" class="mx-auto mb-5 rounded-full shadow-xl border-4 border-white">
            <h1 class="title-text text-orange-500">ë¦´ë ˆì´ ì´ì•¼ê¸° ê³µì‘ì†Œ ğŸ“</h1>
            <p class="text-slate-700 mt-4 text-xl font-gaegu">ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ ìƒìƒì˜ ë‚˜ë˜ë¥¼ í¼ì³ Google Sheetsì— ê¸°ë¡í•´ë´ìš”!</p>
        </header>

        <div id="initial-setup-section" class="text-input-area">
            <h3 class="text-xl font-stylish text-rose-600 mb-3 text-center">ì´ì•¼ê¸° ì‹œì‘ ì¤€ë¹„!</h3>
            <div>
                <label for="student-name">ì´ë¦„:</label>
                <input type="text" id="student-name" placeholder="ì˜ˆ: í™ê¸¸ë™">
            </div>
            <div class="mt-3">
                <label for="student-id">í•™ë²ˆ (ë˜ëŠ” ë³„ëª…):</label>
                <input type="text" id="student-id" placeholder="ì˜ˆ: 10101 ë˜ëŠ” ì´ì•¼ê¸°ìš”ì •">
            </div>
            <div class="mt-4">
                <label for="paste-story-area">ì´ì–´ì„œ ì‘ì„±í•  ì´ì•¼ê¸°ê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš” (ì—†ìœ¼ë©´ ë¹„ì›Œë‘ì„¸ìš”):</label>
                <textarea id="paste-story-area" rows="5" placeholder="ì´ì „ì— ì¹œêµ¬ê°€ ì „ë‹¬í•´ì¤€ ì´ì•¼ê¸° ë‚´ìš©ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”..."></textarea>
            </div>
            <button id="start-story-button" class="mt-4 w-full bg-rose-500 hover:bg-rose-600 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md text-lg">
                ì´ì•¼ê¸° ì‹œì‘ ë˜ëŠ” ì´ì–´ê°€ê¸°!
            </button>
        </div>

        <div id="main-story-interface" class="hidden"> 
            <div id="stage-info" class="story-stage-card mb-8 p-6 rounded-xl relative">
                <img src="https://placehold.co/60x60/d1d5db/4b5563?text=Idea&font=NanumPenScript" alt="ì•„ì´ë””ì–´ ì•„ì´ì½˜" class="absolute top-[-25px] left-[-25px] transform rotate-[-20deg] opacity-80">
                <h2 id="stage-name-display" class="story-stage-name mb-2"></h2>
                <p id="stage-prompt-display" class="story-stage-prompt"></p>
                <p id="instruction-text-display" class="instruction-text mt-3">ì•„ë˜ ì„ íƒì§€ë¥¼ ê³ ë¥´ê±°ë‚˜ ì§ì ‘ ë‚´ìš©ì„ ì¶”ê°€í•˜ì—¬ ì´ì•¼ê¸°ë¥¼ ì´ì–´ê°€ì„¸ìš”.</p> 
            </div>

            <div id="choices-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-6"></div>
            
            <div id="user-input-section" class="text-input-area hidden">
                <textarea id="user-custom-text" rows="3" placeholder="ì—¬ê¸°ì— ë‚˜ë§Œì˜ ì´ì•¼ê¸°ë¥¼ ììœ ë¡­ê²Œ ì ì–´ë³´ì„¸ìš”..."></textarea>
                <button id="add-custom-text-button" class="mt-3 w-full bg-rose-500 hover:bg-rose-600 text-white font-semibold py-2.5 px-4 rounded-lg shadow-md text-lg">
                    ì´ ë‚´ìš© ì¶”ê°€ & Sheetsì— ì €ì¥!
                </button>
            </div>

            <div id="story-output-container" class="story-output-card mb-8 p-6 rounded-lg min-h-[200px] sm:min-h-[250px] relative">
                <img src="https://placehold.co/70x70/c7d2fe/4338ca?text=Scroll&font=Gaegu" alt="ë‘ë£¨ë§ˆë¦¬ ì•„ì´ì½˜" class="absolute bottom-[-30px] right-[-25px] opacity-75 transform rotate-[10deg]">
                <h3 class="text-2xl font-bold mb-4">ğŸ“– ì§€ê¸ˆê¹Œì§€ì˜ ì´ì•¼ê¸° ìŠ¤ì¼€ì¹˜:</h3>
                <div id="story-output" class="story-output-text">
                    ì´ì•¼ê¸°ê°€ ì—¬ê¸°ì— ìŠ¤ì¼€ì¹˜ë©ë‹ˆë‹¤...
                </div>
            </div>
            <div class="text-center mb-6">
                 <button id="copy-current-story-button" class="control-button bg-sky-500 hover:bg-sky-600 text-white border-sky-600">ğŸ“‹ í˜„ì¬ê¹Œì§€ ì´ì•¼ê¸° ë³µì‚¬ (ë‹¤ìŒ ì¹œêµ¬ì—ê²Œ)</button>
            </div>
        </div>
        
        <div id="completed-story-container" class="completed-story-card hidden mb-6 p-8 rounded-xl text-center">
            <img src="https://placehold.co/130x130/fef08a/eab308?text=Tada&font=Gaegu" alt="ì™„ì„± ì¶•í•˜ ì•„ì´ì½˜" class="mx-auto mb-5">
            <h2 class="text-4xl font-bold mb-4">ğŸ‰ ë“œë””ì–´, ë‚˜ë§Œì˜ ëŒ€ì„œì‚¬ì‹œ ì™„ì„±! ğŸ‰</h2>
            <div id="final-story-output" class="completed-story-text text-left p-5 bg-white/60 rounded-lg min-h-[200px]"></div>
        </div>

        <div id="controls" class="text-center mt-10 flex flex-wrap justify-center">
            <button id="reset-button" class="control-button bg-red-400 hover:bg-red-500 text-white border-red-500">ğŸ—‘ï¸ ëª¨ë“  ë‚´ìš© ì§€ìš°ê³  ì™„ì „ ì²˜ìŒë¶€í„°</button>
        </div>
    </div>

    <div id="message-box" class="bg-slate-800 text-white"></div>

    <script>
        // #############################################################################
        // ## ì¤‘ìš”! ì•„ë˜ ë³€ìˆ˜ì— ì„ ìƒë‹˜ì˜ Google Apps Script ì›¹ ì•± URLì„ ë„£ì–´ì£¼ì„¸ìš”! ##
        // #############################################################################
        const APPS_SCRIPT_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxxcq6-kdzMLOz4WQqqkdLFkvRhORmvEmzMqzCkTuVEJGETTg1C280VBg26jUrpfcX5/exec"; // ì˜ˆ: "https://script.google.com/macros/s/ì—¬ê¸°ì—_ì„ ìƒë‹˜ì˜_ì›¹ì•±_ID/exec";
        // ë§Œì•½ APPS_SCRIPT_WEB_APP_URLì´ ë¹„ì–´ìˆìœ¼ë©´, Google Sheets ì €ì¥ì€ ì‹œë„ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

        const initialSetupSection = document.getElementById('initial-setup-section');
        const studentNameInput = document.getElementById('student-name');
        const studentIdInput = document.getElementById('student-id');
        const pasteStoryArea = document.getElementById('paste-story-area');
        const startStoryButton = document.getElementById('start-story-button');
        const mainStoryInterface = document.getElementById('main-story-interface');
        const stageNameDisplay = document.getElementById('stage-name-display');
        const stagePromptDisplay = document.getElementById('stage-prompt-display');
        const instructionTextDisplay = document.getElementById('instruction-text-display');
        const choicesContainer = document.getElementById('choices-container');
        const storyOutput = document.getElementById('story-output');
        const resetButton = document.getElementById('reset-button'); 
        const copyCurrentStoryButton = document.getElementById('copy-current-story-button');
        const stageInfoDiv = document.getElementById('stage-info');
        const storyOutputContainer = document.getElementById('story-output-container');
        const completedStoryContainer = document.getElementById('completed-story-container');
        const finalStoryOutput = document.getElementById('final-story-output');
        const userInputSection = document.getElementById('user-input-section');
        const userCustomTextArea = document.getElementById('user-custom-text');
        const addCustomTextButton = document.getElementById('add-custom-text-button');

        let currentStepIndex = 0;
        let storySegments = []; 
        let currentAuthor = "";
        let currentAuthorNameOnly = ""; 
        let currentAuthorIdOnly = "";   
        let isDecisionPhase = false;

        const buttonColorPalettes = [ 
            ["from-sky-400 to-blue-500 hover:from-sky-500 hover:to-blue-600 border-sky-500"],
            ["from-emerald-400 to-green-500 hover:from-emerald-500 hover:to-green-600 border-emerald-500"],
            ["from-amber-400 to-yellow-500 hover:from-amber-500 hover:to-yellow-600 border-amber-500"],
            ["from-rose-400 to-pink-500 hover:from-rose-500 hover:to-pink-600 border-rose-500"],
            ["from-violet-400 to-purple-500 hover:from-violet-500 hover:to-purple-600 border-violet-500"],
            ["from-teal-400 to-cyan-500 hover:from-teal-500 hover:to-cyan-600 border-teal-500"],
            ["from-fuchsia-400 to-pink-600 hover:from-fuchsia-500 hover:to-pink-700 border-fuchsia-500"]
        ];
        const storySteps = [ 
            { stageName: "ğŸŒ± ë°œë‹¨ 1: ì£¼ì¸ê³µì€ ëˆ„êµ¬?", prompt: "ì´ì•¼ê¸°ë¥¼ ì´ëŒì–´ê°ˆ ì£¼ì¸ê³µì„ ì„ íƒí•´ì£¼ì„¸ìš”!", options: [ { text: "ìš©ê°ë¬´ìŒí•œ ê¸°ì‚¬ ì•„ì„œ", segment: "ë¨¼ ì˜›ë‚ , ì•„ë°œë¡  ì™•êµ­ì—ëŠ” ìš©ê°ë¬´ìŒí•œ ê¸°ì‚¬ ì•„ì„œê°€ ì‚´ê³  ìˆì—ˆìŠµë‹ˆë‹¤. ê·¸ì˜ ì‹¬ì¥ì€ ì‚¬ìì²˜ëŸ¼ ëœ¨ê±°ì› ê³ , ê²€ìˆ ì€ ë°”ëŒì²˜ëŸ¼ ë‚ ë µí–ˆì£ . " }, { text: "ì‹ ë¹„ë¡œìš´ ìˆ²ì˜ ë§ˆë²•ì‚¬ ì—˜ë¦¬ë‚˜", segment: "ê³ ìš”í•˜ê³  ì‹ ë¹„ë¡œìš´ ìˆ˜ì • ìˆ² ê°€ì¥ ê¹Šì€ ê³³, ì§€í˜œë¡œìš´ ë§ˆë²•ì‚¬ ì—˜ë¦¬ë‚˜ê°€ ë³„ë¹›ì„ ë²—ì‚¼ì•„ í™€ë¡œ ê³ ëŒ€ì˜ ë§ˆë²•ì„ íƒêµ¬í–ˆìŠµë‹ˆë‹¤. ê·¸ë…€ì˜ ëˆˆì€ ë°¤í•˜ëŠ˜ì²˜ëŸ¼ ê¹Šì—ˆì£ . " }, { text: "í˜¸ê¸°ì‹¬ ì²œêµ­! ê¼¬ë§ˆ íƒí—˜ê°€ ë¦¬ì˜¤", segment: "ì„¸ìƒì˜ ì˜¨ê°– ë¹„ë°€ì„ íŒŒí—¤ì¹˜ê³  ì‹¶ì–´ ì•ˆë‹¬ì´ ë‚œ, í˜¸ê¸°ì‹¬ ë§ê³  ë°œë„í•œ ê¼¬ë§ˆ íƒí—˜ê°€ ë¦¬ì˜¤ê°€ ìˆì—ˆìŠµë‹ˆë‹¤. ë¦¬ì˜¤ì˜ ê°€ë°©ì—” ì–¸ì œë‚˜ ì‹ ê¸°í•œ ë¬¼ê±´ë“¤ì´ ê°€ë“í–ˆì£ . " } ] },
            { stageName: "âœ¨ ë°œë‹¨ 2: ì‚¬ê±´ì˜ ë¶ˆê½ƒ", prompt: "ì£¼ì¸ê³µì—ê²Œ ì–´ë–¤ í¥ë¯¸ì§„ì§„í•œ ì‚¬ê±´ì´ í¼ì³ì§ˆê¹Œìš”?", options: [ { text: "ë‚¡ì€ ì§€ë„ ì† ë¹„ë°€ì˜ ì˜ˆì–¸", segment: "ì–´ëŠ ë‚ , ì•„ì„œëŠ” ë¨¼ì§€ ìŒ“ì¸ ì™•ê¶ ë„ì„œê´€ êµ¬ì„ì—ì„œ ë¹›ë°”ëœ ì–‘í”¼ì§€ ì§€ë„ë¥¼ ë°œê²¬í–ˆìŠµë‹ˆë‹¤. ì§€ë„ì—ëŠ” 'ì„¸ìƒì„ êµ¬í•  ì „ì„¤ì˜ ì„±ê²€, ì¹¼ë¦¬ë²ˆ'ì˜ ìœ„ì¹˜ê°€ ì‹ ë¹„ë¡œìš´ ë¬¸ìë¡œ ìƒˆê²¨ì ¸ ìˆì—ˆì–´ìš”! " }, { text: "ë§ˆì„ì„ ë’¤ë®ì€ ì–´ë‘ ì˜ ê·¸ë¦¼ì", segment: "ì—˜ë¦¬ë‚˜ê°€ ì‚¬ë‘í•˜ëŠ” ìˆ˜ì • ìˆ²ì— ì •ì²´ ëª¨ë¥¼ ì–´ë‘ ì˜ ê·¸ë¦¼ìê°€ ë“œë¦¬ìš°ê¸° ì‹œì‘í–ˆìŠµë‹ˆë‹¤. ìˆ²ì˜ ìš”ì •ë“¤ì´ ì‹œë¦„ì‹œë¦„ ì•“ê³ , ìˆ˜ì •ê½ƒì´ ë¹›ì„ ìƒì–´ê°€ì ì—˜ë¦¬ë‚˜ëŠ” ì´ ìœ„ê¸°ì˜ ê·¼ì›ì„ ì°¾ì•„ ëª¨í—˜ì„ ë– ë‚˜ê¸°ë¡œ ê²°ì‹¬í•©ë‹ˆë‹¤. " }, { text: "ìˆ¨ê²¨ì§„ ì„¸ê³„ë¡œ í†µí•˜ëŠ” ë§ˆë²•ì˜ ë¬¸", segment: "ìŠí˜€ì§„ ê³ ëŒ€ ì‚¬ì›ì„ íƒí—˜í•˜ë˜ ë¦¬ì˜¤ëŠ” ë²½ì— ê·¸ë ¤ì§„ ì´ìƒí•œ ë¬¸ì–‘ì„ ë§Œì§€ë‹¤ ê·¸ë§Œ, ë³„ë“¤ì²˜ëŸ¼ ë°˜ì§ì´ëŠ” ë¯¸ì§€ì˜ ì„¸ê³„ë¡œ í†µí•˜ëŠ” ë§ˆë²•ì˜ ë¬¸ì„ ìš°ì—°íˆ ì—´ê³  ë§ì•˜ìŠµë‹ˆë‹¤! " } ] },
            { stageName: "ğŸš€ ì „ê°œ 1: ì²« ë²ˆì§¸ ì‹œë ¨", prompt: "ëª¨í—˜ì˜ ì²«ê±¸ìŒ, ì£¼ì¸ê³µ ì•ì—ëŠ” ì–´ë–¤ ë„ì „ì´ ê¸°ë‹¤ë¦¬ê³  ìˆì„ê¹Œìš”?", options: [ { text: "ë§í•˜ëŠ” ë‚˜ë¬´ì˜ ì•Œì­ë‹¬ì­ ìˆ˜ìˆ˜ê»˜ë¼", segment: "ì „ì„¤ì˜ ì„±ê²€ì„ ì°¾ì•„ê°€ëŠ” ìˆ²ê¸¸, ì•„ì„œëŠ” ê¸¸ì„ ê°€ë¡œë§‰ëŠ” ê±°ëŒ€í•œ ë§í•˜ëŠ” ë‚˜ë¬´ì™€ ë§ˆì£¼ì³¤ìŠµë‹ˆë‹¤. ë‚˜ë¬´ëŠ” 'ì„¸ ê°€ì§€ ì§€í˜œì˜ ìˆ˜ìˆ˜ê»˜ë¼'ë¥¼ ëª¨ë‘ ë§ì¶°ì•¼ë§Œ ê¸¸ì„ ì—´ì–´ì£¼ê² ë‹¤ê³  ìœ¼ë¦„ì¥ì„ ë†“ì•˜ìŠµë‹ˆë‹¤. " }, { text: "ì–´ë‘ ì— ë¬¼ë“  ìˆ²ì˜ ê´´ìˆ˜", segment: "ì—˜ë¦¬ë‚˜ëŠ” ìˆ²ì„ ë³‘ë“¤ê²Œ í•˜ëŠ” ì–´ë‘ ì˜ ê·¼ì›ì§€ë¥¼ í–¥í•˜ë˜ ì¤‘, ê²€ì€ ì•ˆê°œì— íœ©ì‹¸ì¸ ê±°ëŒ€í•œ ìˆ²ì˜ ê´´ìˆ˜ 'ê·¸ë¦¼ìë°œí†±'ê³¼ ë§ë‹¥ëœ¨ë ¸ìŠµë‹ˆë‹¤. ë…€ì„ì˜ í¬íš¨ëŠ” ì˜¨ ìˆ²ì„ ë’¤í”ë“¤ì—ˆì£ . " }, { text: "ì¤‘ë ¥ì´ ë’¤ì£½ë°•ì£½! ì´ìƒí•œ ë°©", segment: "ë§ˆë²•ì˜ ë¬¸ì„ í†µê³¼í•œ ë¦¬ì˜¤ëŠ” ì²œì¥ê³¼ ë°”ë‹¥ì´ ë’¤ë°”ë€Œê³ , ë¬¼ê±´ë“¤ì´ ê³µì¤‘ì— ë– ë‹¤ë‹ˆëŠ” ì´ìƒí•œ ë°©ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤. í•œ ë°œì§ë§Œ ì˜ëª» ë””ëŒë„ ì•„ì°”í•œ ìƒí™©ì´ì—ˆì£ ! " } ] },
            { stageName: "ğŸ¤ ì „ê°œ 2: ëœ»ë°–ì˜ ë§Œë‚¨", prompt: "ìœ„ê¸°ì˜ ìˆœê°„, ì£¼ì¸ê³µì„ ë„ì™€ì¤„ íŠ¹ë³„í•œ ì¡°ë ¥ìëŠ” ëˆ„êµ¬ì¼ê¹Œìš”?", options: [ { text: "êµ¬ë¦„ ìœ„ì˜ í˜„ì, ë°±ê¸ˆìš©", segment: "ìˆ˜ìˆ˜ê»˜ë¼ ì•ì—ì„œ ë™ë™ëŒ€ë˜ ì•„ì„œ ì•ì—, êµ¬ë¦„ ìœ„ ë†’ì€ ì‚°ë´‰ìš°ë¦¬ì— ì€ë‘”í•˜ë˜ ì§€í˜œë¡œìš´ ë°±ê¸ˆìš© 'ì•„ë¥´ê²í† ìŠ¤'ê°€ í™€ì—°íˆ ë‚˜íƒ€ë‚˜ ì‹ ë¹„ë¡œìš´ ì¡°ì–¸ì„ ê±´ë„¸ìŠµë‹ˆë‹¤. " }, { text: "ë°˜ì§ì´ëŠ” í¬ë§, ë‹¬ë¹› ìš”ì •", segment: "ê·¸ë¦¼ìë°œí†±ì˜ ê°•ë ¥í•œ ê³µê²©ì— ìœ„ê¸°ì— ì²˜í•œ ì—˜ë¦¬ë‚˜ ì•ì—, ìˆ²ì— ë§ˆì§€ë§‰ ë‚¨ì€ ìˆœìˆ˜í•œ ë¹›ì˜ í˜ì„ ê°„ì§í•œ ì‘ì€ ë‹¬ë¹› ìš”ì • 'ë£¨ë¯¸'ê°€ ë‚˜íƒ€ë‚˜ ì—˜ë¦¬ë‚˜ì˜ ë§ˆë²• ì§€íŒ¡ì´ì— ìƒˆë¡œìš´ í˜ì„ ë¶ˆì–´ë„£ì–´ ì£¼ì—ˆìŠµë‹ˆë‹¤. " }, { text: "ê¸¸ ìœ„ì˜ ë™ë°˜ì, ìœ ì¾Œí•œ ë°œëª…ê°€", segment: "ì´ìƒí•œ ë°©ì—ì„œ ê¸¸ì„ ìƒê³  í—¤ë§¤ë˜ ë¦¬ì˜¤ë¥¼ ë„ì™€ì¤€ ê²ƒì€, ë¨¼ì € ì´ ì„¸ê³„ì— ì™€ì„œ ê¸°ìƒì²œì™¸í•œ ë°œëª…í’ˆë“¤ì„ ë§Œë“¤ê³  ìˆë˜ ìœ ì¾Œí•œ ë°œëª…ê°€ 'ì—ë””ìŠ¨' í• ì•„ë²„ì§€ì˜€ìŠµë‹ˆë‹¤. ë‘˜ì€ ì‹ ë‚˜ê²Œ í•¨ê»˜ ê¸¸ì„ ì°¾ê¸°ë¡œ í•©ë‹ˆë‹¤. " } ] },
            { stageName: "ğŸ’¥ ìœ„ê¸°: ìš´ëª…ì˜ ê°ˆë¦¼ê¸¸", prompt: "ì£¼ì¸ê³µì€ ë§ˆì¹¨ë‚´ ê°€ì¥ í° ìœ„í˜‘ ë˜ëŠ” ê°ˆë“±ê³¼ ì •ë©´ìœ¼ë¡œ ë§ˆì£¼í•©ë‹ˆë‹¤!", options: [ { text: "ì„±ê²€ì„ ì§€í‚¤ëŠ” ê³ ëŒ€ì˜ ê·¸ë¦¼ì ê¸°ì‚¬", segment: "ë§ˆì¹¨ë‚´ ì„±ê²€ ì¹¼ë¦¬ë²ˆì´ ì ë“  ì œë‹¨ì— ë„ë‹¬í•œ ì•„ì„œ. í•˜ì§€ë§Œ ê²€ì€ ê³¼ê±°ì˜ ìš©ë§¹í•œ ì˜í˜¼ì´ ê¹ƒë“  ê°•ë ¥í•œ ê·¸ë¦¼ì ê¸°ì‚¬ì— ì˜í•´ ì§€ì¼œì§€ê³  ìˆì—ˆê³ , ê¸°ì‚¬ëŠ” ì•„ì„œì˜ ì§„ì •í•œ ìš©ê¸°ë¥¼ ì‹œí—˜í•˜ë ¤ í•©ë‹ˆë‹¤. " }, { text: "ì˜› ì¹œêµ¬ì˜ ë°°ì‹ , íƒ€ë½í•œ ëŒ€ë§ˆë²•ì‚¬", segment: "ì—˜ë¦¬ë‚˜ëŠ” ìˆ² íŒŒê´´ì˜ ë°°í›„ê°€ ë°”ë¡œ ìì‹ ì˜ ì˜› ê°€ì¥ ì¹œí•œ ì¹œêµ¬ì´ì ìœ„ëŒ€í•œ ë§ˆë²•ì‚¬ì˜€ë˜ 'ì„¸ë¼í”¼ë‚˜'ê°€ ì–´ë‘ ì˜ í˜ì— íƒ€ë½í–ˆê¸° ë•Œë¬¸ì„ì„ ì•Œê²Œ ë©ë‹ˆë‹¤. ì„¸ë¼í”¼ë‚˜ëŠ” ì—˜ë¦¬ë‚˜ì—ê²Œ í•¨ê»˜ ì„¸ìƒì„ ì§€ë°°í•˜ìê³  ìœ í˜¹í•©ë‹ˆë‹¤. " }, { text: "ì„¸ê³„ì˜ ê· í˜•ì„ ìœ„í˜‘í•˜ëŠ” í˜¼ëˆì˜ ì†Œìš©ëŒì´", segment: "ë¦¬ì˜¤ì™€ ì—ë””ìŠ¨ í• ì•„ë²„ì§€ëŠ” ì´ ì°¨ì›ì˜ ì‹¬ì¥ë¶€ì—ì„œ, ëª¨ë“  ì„¸ê³„ì˜ ê· í˜•ì„ ë¹¨ì•„ë“¤ì—¬ ë¬´ë¡œ ëŒë¦¬ë ¤ëŠ” ê±°ëŒ€í•œ 'í˜¼ëˆì˜ ì†Œìš©ëŒì´'ê°€ ê±·ì¡ì„ ìˆ˜ ì—†ì´ ì»¤ì§€ê³  ìˆë‹¤ëŠ” ì‚¬ì‹¤ì„ ë°œê²¬í•©ë‹ˆë‹¤. " } ] },
            { stageName: "ğŸŒŸ ì ˆì •: ë¹›ë‚˜ëŠ” ìš©ê¸°", prompt: "ì ˆì²´ì ˆëª…ì˜ ìœ„ê¸°! ì£¼ì¸ê³µì€ ì´ ìˆœê°„ì„ ì–´ë–»ê²Œ ê·¹ë³µí• ê¹Œìš”?", options: [ { text: "ë§ˆìŒì˜ ê²€ìœ¼ë¡œ ìŠ¹ë¦¬í•˜ë‹¤", segment: "ì•„ì„œëŠ” ê·¸ë¦¼ì ê¸°ì‚¬ì™€ì˜ ìˆ¨ ë§‰íˆëŠ” ê²°íˆ¬ ëì—, ë‹¨ìˆœí•œ ë¬´ë ¥ì´ ì•„ë‹Œ ë°±ì„±ì„ ì§€í‚¤ê³ ì í•˜ëŠ” ìˆœìˆ˜í•œ ë§ˆìŒê³¼ ì§„ì •í•œ ìš©ê¸°ë¥¼ ì¦ëª…í•©ë‹ˆë‹¤. ì´ì— ê°ì‘í•œ ì„±ê²€ ì¹¼ë¦¬ë²ˆì€ ìŠ¤ìŠ¤ë¡œ ì•„ì„œì˜ ì†ì— ë“¤ë ¤ ë¹›ì„ ë°œí•©ë‹ˆë‹¤! " }, { text: "ìš°ì •ì˜ ë¹›ìœ¼ë¡œ ì–´ë‘ ì„ ë¬¼ë¦¬ì¹˜ë‹¤", segment: "ì—˜ë¦¬ë‚˜ëŠ” ì„¸ë¼í”¼ë‚˜ì˜ ìœ í˜¹ì„ ë‹¨í˜¸íˆ ë¿Œë¦¬ì¹˜ê³ , ê³¼ê±° í•¨ê»˜ í–ˆë˜ ì†Œì¤‘í•œ ì¶”ì–µê³¼ ìš°ì •ì˜ í˜ì„ ë‹´ì€ ì •í™”ì˜ ë§ˆë²•ì„ ì‹œì „í•©ë‹ˆë‹¤. ì„¸ë¼í”¼ë‚˜ì˜ ë§ˆìŒì† ê¹Šì€ ê³³ì— ë‚¨ì•„ìˆë˜ ì‘ì€ ë¹›ì´ ì–´ë‘ ì„ ëª°ì•„ë‚´ê¸° ì‹œì‘í•©ë‹ˆë‹¤. " }, { text: "ìƒìƒë ¥ê³¼ í˜‘ë™ìœ¼ë¡œ ê· í˜•ì„ ë˜ì°¾ë‹¤", segment: "ë¦¬ì˜¤ì™€ ì—ë””ìŠ¨ í• ì•„ë²„ì§€ëŠ” ì ˆë§í•˜ì§€ ì•Šê³ , ë¦¬ì˜¤ì˜ ë¹›ë‚˜ëŠ” ìƒìƒë ¥ê³¼ ì—ë””ìŠ¨ í• ì•„ë²„ì§€ì˜ ê¸°ë°œí•œ ë°œëª…í’ˆë“¤ì„ ì´ë™ì›í•©ë‹ˆë‹¤. ë‘˜ì˜ ì™„ë²½í•œ í˜‘ë™ìœ¼ë¡œ 'í˜¼ëˆì˜ ì†Œìš©ëŒì´'ì˜ ì—ë„ˆì§€ë¥¼ ì—­ì „ì‹œì¼œ ì„¸ê³„ì˜ ê· í˜•ì„ ë˜ì°¾ëŠ”ë° ì„±ê³µí•©ë‹ˆë‹¤! " } ] },
            { stageName: "ğŸŒˆ ê²°ë§: ìƒˆë¡œìš´ ë‚´ì¼", prompt: "ëª¨ë“  ì‹œë ¨ì„ ì´ê²¨ë‚¸ ì£¼ì¸ê³µì˜ ì´ì•¼ê¸°ëŠ” ì–´ë–»ê²Œ ì•„ë¦„ë‹µê²Œ ë§ˆë¬´ë¦¬ë ê¹Œìš”?", options: [ { text: "í‰í™”ì˜ ì‹œëŒ€ë¥¼ ì—° ìœ„ëŒ€í•œ ì˜ì›…ì™•", segment: "ì•„ì„œëŠ” ì„±ê²€ ì¹¼ë¦¬ë²ˆì˜ í˜ìœ¼ë¡œ ì™•êµ­ì„ ìœ„í˜‘í•˜ë˜ ëª¨ë“  ì–´ë‘ ì„ ë¬¼ë¦¬ì¹˜ê³ , ë°±ì„±ë“¤ì˜ ëœ¨ê±°ìš´ ì§€ì§€ ì†ì— ì•„ë°œë¡ ì˜ ìœ„ëŒ€í•œ ì˜ì›…ì™•ìœ¼ë¡œ ì¶”ëŒ€ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ì˜ í†µì¹˜ ì•„ë˜ ì™•êµ­ì—ëŠ” ì˜ì›í•œ í‰í™”ì™€ ë²ˆì˜ì˜ ì‹œëŒ€ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤. " }, { text: "ìƒëª…ì˜ ìˆ²ì„ ì§€í‚¤ëŠ” ëŒ€í˜„ì", segment: "ì—˜ë¦¬ë‚˜ëŠ” ì •í™”ëœ ìˆ˜ì • ìˆ²ê³¼, ë§ˆìŒì„ ë˜ì°¾ì€ ì„¸ë¼í”¼ë‚˜ì™€ í•¨ê»˜ ìˆ²ì˜ ìƒˆë¡œìš´ ìˆ˜í˜¸ìì´ì ëŒ€í˜„ìê°€ ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ë…€ì˜ ì§€í˜œì™€ ë§ˆë²•ì€ ëª¨ë“  ìƒëª…ê³¼ ì¡°í™”ë¡­ê²Œ ì–´ìš°ëŸ¬ì ¸ ìˆ²ì„ ë”ìš± ì‹ ë¹„ë¡­ê³  í’ìš”ë¡œìš´ ë‚™ì›ìœ¼ë¡œ ê°€ê¾¸ì—ˆìŠµë‹ˆë‹¤. " }, { text: "ëì—†ëŠ” ìš°ì£¼ë¥¼ í–¥í•œ ê¿ˆì˜ íƒí—˜ê°€", segment: "ë¦¬ì˜¤ì™€ ì—ë””ìŠ¨ í• ì•„ë²„ì§€ëŠ” ìì‹ ë“¤ì´ ì§€ì¼œë‚¸ ì•„ë¦„ë‹¤ìš´ ì°¨ì›ì„ ë’¤ë¡œí•˜ê³ , ì§ì ‘ ë§Œë“  ë°˜ì§ì´ëŠ” ìš°ì£¼ì„  'ê¿ˆë‚˜ë˜í˜¸'ë¥¼ íƒ€ê³  ì•„ì§ ì•„ë¬´ë„ ê°€ë³´ì§€ ëª»í•œ ì‹ ë¹„ë¡œìš´ ìš°ì£¼ì™€ ìƒˆë¡œìš´ ì°¨ì›ì„ í–¥í•œ ê°€ìŠ´ ë›°ëŠ” íƒí—˜ì„ ë‹¤ì‹œ ì‹œì‘í–ˆìŠµë‹ˆë‹¤. ê·¸ë“¤ì˜ ëª¨í—˜ì€ ì´ì œ ë§‰ ì‹œì‘ëœ ê²ƒì´ì£ ! " } ] }
        ];

        function showMessage(message, type = 'info') { 
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            const baseClasses = 'fixed bottom-5 left-1/2 p-3 rounded-lg shadow-xl z-[1000] opacity-0 invisible transition-all duration-300 font-gaegu text-lg';
            
            let typeClasses = 'bg-slate-700 text-white border-2 border-slate-500';
            if (type === 'success') {
                typeClasses = 'bg-green-500 text-white border-2 border-green-700';
            } else if (type === 'error') {
                typeClasses = 'bg-red-500 text-white border-2 border-red-700';
            }
            messageBox.className = `${baseClasses} ${typeClasses}`;
            
            messageBox.classList.add('show');
            messageBox.classList.remove('opacity-0', 'invisible', 'transform', '-translate-x-1/2');
            messageBox.classList.add('opacity-100', 'visible');
            messageBox.style.transform = 'translateX(-50%) translateY(-10px)';

            setTimeout(() => {
                messageBox.classList.remove('show', 'opacity-100', 'visible');
                messageBox.classList.add('opacity-0', 'invisible');
                messageBox.style.transform = 'translateX(-50%)';
            }, 3000);
        }

        function parsePastedStory(pastedText) { 
            const segments = [];
            const lines = pastedText.split('\n');
            let currentAuthorForParse = "ì•Œ ìˆ˜ ì—†ëŠ” ì‘ì„±ì";
            let currentTextForParse = "";
            const authorRegex = /^\[ì‘ì„±ì:\s*(.+?)\s*\]$/; 
            const separatorRegex = /^~+.*?~+$/; 
            const titleRegex = /^===.*?===$/; 

            for (const line of lines) {
                const authorMatch = line.match(authorRegex);
                const separatorMatch = line.match(separatorRegex);
                const titleMatch = line.match(titleRegex);

                if (titleMatch) { 
                    continue;
                } else if (authorMatch) {
                    if (currentTextForParse.trim() !== "") {
                        segments.push({ author: currentAuthorForParse, text: currentTextForParse.trim() + " " });
                    }
                    currentAuthorForParse = authorMatch[1];
                    currentTextForParse = "";
                } else if (separatorMatch) {
                     if (currentTextForParse.trim() !== "") {
                        segments.push({ author: currentAuthorForParse, text: currentTextForParse.trim() + " " });
                    }
                    segments.push({ author: "ì•Œë¦¼", text: line.trim() + "\n\n" });
                    currentAuthorForParse = "ì•Œ ìˆ˜ ì—†ëŠ” ì‘ì„±ì"; 
                    currentTextForParse = "";
                } else if (line.trim() !== "") {
                    currentTextForParse += line + "\n";
                }
            }
            if (currentTextForParse.trim() !== "") {
                segments.push({ author: currentAuthorForParse, text: currentTextForParse.trim() + " " });
            }
            return segments;
        }

        function updateStoryOutput() { 
            storyOutput.innerHTML = ""; 
            if (storySegments.length === 0) {
                storyOutput.textContent = "ì´ì•¼ê¸°ê°€ ì—¬ê¸°ì— ìŠ¤ì¼€ì¹˜ë©ë‹ˆë‹¤...";
                return;
            }
            storySegments.forEach(seg => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = 'story-segment';
                
                const authorSpan = document.createElement('span');
                authorSpan.className = 'segment-author';
                authorSpan.textContent = `ì‘ì„±ì: ${seg.author}`;
                segmentDiv.appendChild(authorSpan);

                const cleanedText = seg.text.trim().replace(/\s+/g, ' ');
                const textNode = document.createTextNode(cleanedText + " "); 
                segmentDiv.appendChild(textNode);
                
                storyOutput.appendChild(segmentDiv);
            });
        }
        
        async function sendToAppsScript(segmentData) {
            if (!APPS_SCRIPT_WEB_APP_URL) {
                console.warn("Apps Script Web App URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Sheets ì €ì¥ì„ ê±´ë„ˆëœë‹ˆë‹¤.");
                return; 
            }
            const dataToSend = {
                name: currentAuthorNameOnly, 
                id: currentAuthorIdOnly,     
                segment: segmentData.text    
            };
            console.log("Sending to Apps Script:", dataToSend); // ë°ì´í„° ì „ì†¡ ì „ ë¡œê·¸

            try {
                const response = await fetch(APPS_SCRIPT_WEB_APP_URL, {
                    method: "POST",
                    mode: "no-cors", 
                    body: new URLSearchParams(dataToSend).toString(), 
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                });
                // mode: 'no-cors'ì—ì„œëŠ” ì‘ë‹µì„ ì§ì ‘ í™•ì¸í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ì„±ê³µí–ˆë‹¤ê³  ê°€ì •í•˜ê³  ë©”ì‹œì§€ í‘œì‹œ
                showMessage("ì´ì•¼ê¸° ì¡°ê°ì´ Google Sheetsë¡œ ì „ì†¡ ì‹œë„ë˜ì—ˆìŠµë‹ˆë‹¤.", "info");
                console.log("Data send attempt to Apps Script was made.");
            } catch (error) {
                console.error("Apps Scriptë¡œ ë°ì´í„° ì „ì†¡ ì¤‘ ì˜¤ë¥˜:", error);
                showMessage("ì´ì•¼ê¸° ì¡°ê°ì„ Sheetsë¡œ ì „ì†¡ ì¤‘ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
            }
        }

        startStoryButton.addEventListener('click', () => {
            const name = studentNameInput.value.trim();
            const id = studentIdInput.value.trim();
            const pastedText = pasteStoryArea.value.trim();

            if (!name || !id) {
                showMessage("ì´ë¦„ê³¼ í•™ë²ˆ(ë³„ëª…)ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”!", "error");
                return;
            }
            currentAuthorNameOnly = name;
            currentAuthorIdOnly = id;
            currentAuthor = `${name} (${id})`;
            
            if (pastedText) {
                storySegments = parsePastedStory(pastedText);
                const lastSegment = storySegments.length > 0 ? storySegments[storySegments.length - 1] : null;
                if (lastSegment && lastSegment.author === "ì•Œë¦¼" && lastSegment.text.includes("ë‹¤ìŒ ì‘ê°€ì˜ ì´ì•¼ê¸°")) {
                    currentStepIndex = 1; 
                } else if (storySegments.length > 0) {
                    currentStepIndex = 1; 
                    storySegments.push({ author: "ì•Œë¦¼", text: "\n~~~~~~~~~~~~~ ë‹¤ìŒ ì‘ê°€ì˜ ì´ì•¼ê¸° ~~~~~~~~~~~~~\n" });
                } else { 
                    storySegments = [];
                    currentStepIndex = 0;
                }
                showMessage("ì´ì „ ì´ì•¼ê¸°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤! ì´ì•¼ê¸°ë¥¼ ì´ì–´ê°€ì„¸ìš”.", "success");
            } else { 
                storySegments = [];
                currentStepIndex = 0;
                showMessage(`${currentAuthor}ë‹˜, í™˜ì˜í•©ë‹ˆë‹¤! ìƒˆë¡œìš´ ì´ì•¼ê¸°ë¥¼ ì‹œì‘í•˜ì„¸ìš”.`, "success");
            }
            
            initialSetupSection.classList.add('hidden');
            mainStoryInterface.classList.remove('hidden');
            completedStoryContainer.classList.add('hidden'); 
            
            renderStep();
        });

        function renderStep() {
            console.log("renderStep í˜¸ì¶œë¨. currentStepIndex:", currentStepIndex); // ë””ë²„ê¹… ë¡œê·¸
            userInputSection.classList.add('hidden'); 
            userCustomTextArea.value = ""; 
            isDecisionPhase = false; 
            instructionTextDisplay.textContent = "ì•„ë˜ ì„ íƒì§€ë¥¼ ê³ ë¥´ê±°ë‚˜ ì§ì ‘ ë‚´ìš©ì„ ì¶”ê°€í•˜ì—¬ ì´ì•¼ê¸°ë¥¼ ì´ì–´ê°€ì„¸ìš”.";

            if (currentStepIndex < 0 || currentStepIndex >= storySteps.length) {
                console.error("ì˜ëª»ëœ currentStepIndex:", currentStepIndex, "storySteps ê¸¸ì´:", storySteps.length);
                showMessage("ì´ì•¼ê¸° ë‹¨ê³„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", "error");
                mainStoryInterface.classList.add('hidden');
                initialSetupSection.classList.remove('hidden');
                studentNameInput.focus();
                return;
            }
            const currentStep = storySteps[currentStepIndex];
            console.log("í˜„ì¬ ë‹¨ê³„ ê°ì²´:", currentStep); // ë””ë²„ê¹… ë¡œê·¸

            if (!currentStep || !currentStep.options || !Array.isArray(currentStep.options)) {
                console.error("í˜„ì¬ ë‹¨ê³„ ë˜ëŠ” ì„ íƒì§€ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:", currentStep);
                showMessage("í˜„ì¬ ì´ì•¼ê¸° ë‹¨ê³„ì˜ ì„ íƒì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", "error");
                mainStoryInterface.classList.add('hidden');
                initialSetupSection.classList.remove('hidden');
                studentNameInput.focus();
                return;
            }
            console.log("í˜„ì¬ ë‹¨ê³„ ì„ íƒì§€:", currentStep.options); // ë””ë²„ê¹… ë¡œê·¸

            stageNameDisplay.textContent = currentStep.stageName;
            stagePromptDisplay.textContent = currentStep.prompt;
            
            choicesContainer.innerHTML = ""; 

            const currentPalette = buttonColorPalettes[currentStepIndex % buttonColorPalettes.length];

            currentStep.options.forEach((option, index) => { 
                console.log("ì„ íƒì§€ ë²„íŠ¼ ìƒì„± ì¤‘:", index, option.text); // ë””ë²„ê¹… ë¡œê·¸
                const button = document.createElement('button');
                button.textContent = option.text;
                button.className = `choice-button w-full bg-gradient-to-br ${currentPalette[0]} text-white font-bold py-4 px-5 rounded-xl shadow-lg`;
                button.onclick = () => handleChoice(option.segment);
                choicesContainer.appendChild(button);
            });

            const addOwnChoiceButton = document.createElement('button');
            addOwnChoiceButton.innerHTML = `âœï¸ <span class="font-stylish">ë‚˜ë§Œì˜ ë¬¸ì¥ ì¶”ê°€í•˜ê¸°</span>`;
            addOwnChoiceButton.className = `choice-button w-full bg-gradient-to-br from-gray-300 to-gray-400 hover:from-gray-400 hover:to-gray-500 text-slate-800 border-slate-500 font-bold py-4 px-5 rounded-xl shadow-lg mt-2`;
            addOwnChoiceButton.onclick = () => {
                userInputSection.classList.remove('hidden');
                userCustomTextArea.focus();
                choicesContainer.querySelectorAll('.choice-button').forEach(btn => {
                    if (btn !== addOwnChoiceButton) btn.disabled = true; 
                });
                addOwnChoiceButton.disabled = true; 
            };
            choicesContainer.appendChild(addOwnChoiceButton);

            updateStoryOutput();
            choicesContainer.querySelectorAll('.choice-button').forEach(btn => btn.disabled = false);
        }
        
        addCustomTextButton.addEventListener('click', () => {
            const customText = userCustomTextArea.value.trim();
            if (customText) {
                const newSegment = { author: currentAuthor, text: customText + " " };
                handleChoice(newSegment.text, true); 
                userInputSection.classList.add('hidden');
                userCustomTextArea.value = "";
            } else {
                showMessage("ì¶”ê°€í•  ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!", "error");
            }
        });

        function handleChoice(segmentText, isCustom = false) {
            const newSegmentData = { author: currentAuthor, text: segmentText };
            storySegments.push(newSegmentData);
            sendToAppsScript(newSegmentData); 

            currentStepIndex++;
            if (currentStepIndex >= storySteps.length) { 
                handleEndOfChapter();
            } else {
                renderStep();
            }
            choicesContainer.querySelectorAll('.choice-button').forEach(btn => btn.disabled = false);
            showMessage("ì¢‹ì•„ìš”! ì´ì•¼ê¸°ê°€ ì´ì–´ì§€ê³  Sheetsì— ê¸°ë¡(ì‹œë„)ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
        }

        function handleEndOfChapter() { 
            isDecisionPhase = true; 
            stageNameDisplay.textContent = "ğŸ“– ì´ì•¼ê¸°ì˜ ì „í™˜ì ";
            stagePromptDisplay.textContent = "í˜„ì¬ ì±•í„°ì˜ ì´ì•¼ê¸°ê°€ ë§ˆë¬´ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì–´ë–»ê²Œ í• ê¹Œìš”?";
            instructionTextDisplay.textContent = "ì•„ë˜ ë²„íŠ¼ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ë‹¤ìŒ í–‰ë™ì„ ê²°ì •í•´ì£¼ì„¸ìš”.";
            choicesContainer.innerHTML = ""; 
            userInputSection.classList.add('hidden'); 
            storyOutputContainer.classList.remove('hidden'); 
            updateStoryOutput();

            const finalizeBtn = document.createElement('button');
            finalizeBtn.innerHTML = `ğŸ <span class="font-stylish">ì´ì•¼ê¸° ì—¬ê¸°ì„œ ìµœì¢… ì™„ì„±!</span>`;
            finalizeBtn.className = "decision-button choice-button w-full bg-gradient-to-br from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white border-green-600 font-bold py-4 px-5 rounded-xl shadow-lg";
            finalizeBtn.onclick = finalizeStory;
            choicesContainer.appendChild(finalizeBtn);

            const continueBtn = document.createElement('button');
            continueBtn.innerHTML = `ë¦´ë ˆì´ ğŸš€ <span class="font-stylish">ë‹¤ìŒ ì¹œêµ¬ì—ê²Œ ë„˜ê¸°ê¸° (ìƒˆ ì±•í„° ì‹œì‘)</span>`;
            continueBtn.className = "decision-button choice-button w-full bg-gradient-to-br from-purple-500 to-violet-600 hover:from-purple-600 hover:to-violet-700 text-white border-purple-600 font-bold py-4 px-5 rounded-xl shadow-lg mt-3";
            continueBtn.onclick = continueStoryRelay;
            choicesContainer.appendChild(continueBtn);
        }
        function finalizeStory() { 
            isDecisionPhase = false;
            mainStoryInterface.classList.add('hidden');
            completedStoryContainer.classList.remove('hidden');
            finalStoryOutput.innerHTML = ""; 
            storySegments.forEach(seg => {
                const segmentDiv = document.createElement('div');
                segmentDiv.className = 'story-segment';
                const authorSpan = document.createElement('span');
                authorSpan.className = 'segment-author';
                authorSpan.textContent = `ì‘ì„±ì: ${seg.author}`;
                segmentDiv.appendChild(authorSpan);
                const textNode = document.createTextNode(seg.text.trim() + " ");
                segmentDiv.appendChild(textNode);
                finalStoryOutput.appendChild(segmentDiv);
            });
            resetButton.textContent = "âœ¨ ìƒˆ ì´ì•¼ê¸° ì™„ì „ ì²˜ìŒë¶€í„° ì‹œì‘í•˜ê¸° âœ¨";
            copyCurrentStoryButton.classList.add('hidden'); 
            showMessage("ì§œì”! ëª¨ë‘ì˜ ì´ì•¼ê¸°ê°€ ì™„ì„±ë˜ì—ˆì–´ìš”!", "success");
        }

        function continueStoryRelay() { 
            isDecisionPhase = false;
            choicesContainer.innerHTML = ""; 
            mainStoryInterface.classList.add('hidden');
            initialSetupSection.classList.remove('hidden'); 
            studentNameInput.value = ""; 
            studentIdInput.value = "";
            pasteStoryArea.value = ""; 
            updateStoryOutput(); 
            showMessage("ë‹¤ìŒ ì‘ê°€ë‹˜, ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ì´ì „ ì´ì•¼ê¸°ë¥¼ ë¶™ì—¬ë„£ê±°ë‚˜ ìƒˆë¡œ ì‹œì‘í•˜ì„¸ìš”!", "info");
        }
        
        resetButton.addEventListener('click', () => {
            if (confirm("ì •ë§ë¡œ ëª¨ë“  ë‚´ìš©ì„ ì§€ìš°ê³  ì™„ì „íˆ ì²˜ìŒë¶€í„° ìƒˆë¡œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ Google Sheetsì— ì´ë¯¸ ì €ì¥ëœ ë‚´ìš©ì„ ì§€ìš°ì§€ëŠ” ì•ŠìŠµë‹ˆë‹¤.")) {
                isDecisionPhase = false; 
                currentStepIndex = 0;
                storySegments = [];
                currentAuthor = "";
                currentAuthorNameOnly = "";
                currentAuthorIdOnly = "";
                mainStoryInterface.classList.add('hidden');
                completedStoryContainer.classList.add('hidden');
                initialSetupSection.classList.remove('hidden');
                studentNameInput.value = "";
                studentIdInput.value = "";
                pasteStoryArea.value = "";
                studentNameInput.focus();
                updateStoryOutput();
                showMessage("ëª¨ë“  ì´ì•¼ê¸°ê°€ ì›¹ì•±ì—ì„œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ì‘ê°€ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ìƒˆë¡œ ì‹œì‘í•˜ì„¸ìš”.", "info");
            }
        });

        copyCurrentStoryButton.addEventListener('click', () => { 
            let fullStoryText = "=== ë¦´ë ˆì´ ì´ì•¼ê¸° ===\n\n";
            storySegments.forEach(seg => {
                if (seg.author === "ì•Œë¦¼") { 
                    fullStoryText += `${seg.text.trim()}\n\n`;
                } else {
                    fullStoryText += `[ì‘ì„±ì: ${seg.author}]\n${seg.text.trim()}\n\n`;
                }
            });
            navigator.clipboard.writeText(fullStoryText.trim())
                .then(() => {
                    showMessage("í˜„ì¬ê¹Œì§€ì˜ ì´ì•¼ê¸°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ë‹¤ìŒ ì¹œêµ¬ì—ê²Œ ì „ë‹¬í•´ì£¼ì„¸ìš”.", "success");
                })
                .catch(err => {
                    showMessage("ì´ì•¼ê¸° ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", "error");
                    console.error('Failed to copy story: ', err);
                });
        });

        window.onload = () => { 
            isDecisionPhase = false; 
            initialSetupSection.classList.remove('hidden');
            mainStoryInterface.classList.add('hidden');
            completedStoryContainer.classList.add('hidden');
            studentNameInput.focus();
            showMessage("ì‘ê°€ë‹˜, ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  ì´ì•¼ê¸° ë§Œë“¤ê¸°ë¥¼ ì‹œì‘í•˜ì„¸ìš”!");
        };

    </script>
</body>
</html>
